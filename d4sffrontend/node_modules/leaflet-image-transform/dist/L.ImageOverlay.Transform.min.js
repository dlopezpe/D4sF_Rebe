L.ImageOverlay.Transform={},L.ImageOverlay.Transform.Marker=L.CircleMarker.extend({options:{name:null,radius:5,fillColor:"#ffffff",color:"#202020",fillOpacity:1,weight:2,opacity:1,cursor:"all-scroll",className:"leaflet-image-overlay-transform-marker"},onAdd:function(t){L.CircleMarker.prototype.onAdd.call(this,t);var a=this._path,i=this.options;a&&(i.cursor&&(a.style.cursor=i.cursor),i.name&&L.DomUtil.addClass(a,"leaflet-image-overlay-transform-marker--"+i.name))},setCursor:function(t){this._path.style.cursor=t}}),L.ImageOverlay.Transform=L.ImageOverlay.extend({options:{rotatable:!0,scalable:!0,draggable:!0,keepRatio:!1,fit:!0,markerClass:L.ImageOverlay.Transform.Marker,lineGuideOptions:{weight:1,opacity:1,dashArray:[3,3],fill:!1}},initialize:function(t,a,i){this._polygon=null,this._handlers=null,this._handlersGroup=null,this._parseLatLngs(a),"string"==typeof t?this._url=t:this._rawImage=t,this.setOptions(i)},onAdd:function(t){var a=this.options,i=this._image;i||(this._initImage(),i=this._image),a.opacity<1&&this._updateOpacity();var e=this._rawImage;L.DomUtil.addClass(e,"leaflet-interactive"),this.addInteractiveTarget(e),this.getPane().appendChild(i),t.on("zoomend resetview",this._reset,this).on("zoomend",this._onMapZoomEnd,this).on("mouseup mouseout",this._endAction,this),this.on("mousedown",this._onDragStart,this),this._map=t,this._reset(),this._resetMarkers()},onRemove:function(t){t.off("zoomend resetview",this._reset,this).off("zoomend",this._onMapZoomEnd,this),this.off("mousedown",this._onDragStart,this),this._removeMarkers(),L.ImageOverlay.prototype.onRemove.call(this,t)},setOptions:function(t){t=L.extend({},this.options,t),this.options.interactive=!0,L.setOptions(this,t),t.draggable&&(this._draggable=!0),t.scalable&&(this._scalable=!0),t.rotatable&&(this._rotatable=!0),t.fit&&(this._fit=!0),t.minWidth&&(this._minWidth=t.minWidth),t.minHeight&&(this._minHeight=t.minHeight),t.keepRatio&&(this._keepRatio=!0),t.lineGuideOptions&&(this._lineGuideOptions=t.lineGuideOptions),t.markerClass&&(this._markerClass=t.markerClass),this._reset(),this._resetMarkers()},getLatLngs:function(){return this._latlngs},setLatLngs:function(t){this._parseLatLngs(t),this._reset(),this._resetMarkers()},setUrl:function(t){return this._url=t,this._rawImage&&(this._rawImage.src=t),this},_onMapZoomEnd:function(){this._resetMarkers()},_onDragStart:function(t){if(this._draggable){var a=this._map,i=this._latlngs;this._dragging=!0,this._startPoint=t.layerPoint,this._startLatLngs=i,this.bringToFront(),a.dragging.enabled()&&(this._disabledDrag=!0,a.dragging.disable()),a.on("mousemove",this._onDrag,this).on("mouseup",this._onDragEnd,this),this.fire("dragstart",{latlngs:i})}},_onDrag:function(t){if(this._dragging){this._map;var a=this._startLatLngs,i=this._startPoint,e=t.layerPoint,s=e.x-i.x,n=e.y-i.y;if(s||n){var r=this._moveLatLngs(s,n,a);this.setLatLngs(r),this.fire("drag",{latlngs:r})}}},_onDragEnd:function(){var t=this._map;if(this._disabledDrag&&(t.dragging.enable(),delete this._disabledDrag),this._dragging){var a=this._latlngs;delete this._dragging,delete this._startPoint,delete this._startLatLngs,this.fire("dragend",{latlngs:a})}},_onScaleStart:function(t){if(this._scalable){var a=this._map,i=this._latlngs;this._scaling=!0,this._startPoint=t.layerPoint,this._startLatLngs=i.slice(0),this._activeMarkerName=t.target.options.name,this._startDiagonal=this._diagonal,this.bringToFront(),a.dragging.enabled()&&(this._disabledDrag=!0,a.dragging.disable()),a.on("mousemove",this._onScale,this).on("mouseup",this._onScaleEnd,this),this.fire("scalestart",{latlngs:i})}},_onScale:function(t){if(this._scaling){var a=this._startPoint,i=t.layerPoint,e=i.x-a.x,s=i.y-a.y;if(e||s){this._map;var n=this._startDiagonal,r=this._startLatLngs,o=this._activeMarkerName,h=this._keepRatio,l=this._scaleLatLngs(e,s,o,r,h,n);this.setLatLngs(l),this.fire("scale",{latlngs:l})}}},_onScaleEnd:function(){var t=this._map;if(this._disabledDrag&&(t.dragging.enable(),delete this._disabledDrag),this._scaling){var a=this._latlngs;delete this._scaling,delete this._startPoint,delete this._startLatLngs,delete this._activeMarker,delete this._radian,delete this._startWidth,delete this._startHeight,this.fire("scaleend",{latlngs:a})}},_onRotateStart:function(t){if(this._rotatable){var a=this._map,i=this._latlngs;this._rotating=!0,this._startPoint=t.layerPoint,this._startLatLngs=i.slice(0),this.bringToFront(),a.dragging.enabled()&&(this._disabledDrag=!0,a.dragging.disable()),a.on("mousemove",this._onRotate,this).on("mouseup",this._onRotateEnd,this),this.fire("rotatestart",{latlngs:i})}},_onRotate:function(t){if(this._rotating){for(var a=this._map,i=this._startPoint,e=this._startLatLngs,s=t.layerPoint,n=a.latLngToLayerPoint(this._getCenterOfLatLngs(e)),r=Math.atan2(s.y-n.y,s.x-n.x)-Math.atan2(i.y-n.y,i.x-n.x);r>2*Math.PI;)r/=2*Math.PI;var o=this._rotateLatLngs(r,e,n);this.setLatLngs(o),this.fire("rotate",{latlngs:o})}},_onRotateEnd:function(){var t=this._map;if(this._disabledDrag&&(t.dragging.enable(),delete this._disabledDrag),this._rotating){var a=this._latlngs;delete this._rotating,delete this._startPoint,delete this._startLatLngs,this.fire("rotateend",{latlngs:a})}},_endAction:function(){this._onDragEnd(),this._onScaleEnd(),this._onRotateEnd()},_reset:function(){var t=this._map;if(t){var a=this._rawImage,i=this._image,e=this._latlngs,s=t.latLngToLayerPoint(this._topLeft),n=t.latLngToLayerPoint(this._topRight),r=t.latLngToLayerPoint(this._bottomLeft),o=t.latLngToLayerPoint(this._bottomRight),h=L.bounds([s,n,r,o]),l=(h.getSize(),s.subtract(h.min)),g=n.subtract(s),_=r.subtract(s),d=Math.atan2(g.y,g.x),m=Math.atan2(_.x,_.y);this._bounds=L.latLngBounds(t.layerPointToLatLng(h.min),t.layerPointToLatLng(h.max));var f=a.width,c=a.height;if(f||c){var y=this._fit,p=Math.ceil(s.distanceTo(n)),u=Math.ceil(s.distanceTo(r)),v=p/u,b=f/c;y||(b>v?(e=this._latlngs=this._scaleLatLngs(0,p/b-u,"bottomRight",e.slice(0),!1),u=Math.ceil(p/b)):(e=this._latlngs=this._scaleLatLngs(u*b-p,0,"topRight",e.slice(0),!1),p=Math.ceil(u*b)),this._parseLatLngs(e),this._resetMarkers(),this._fit=!0),this._width=p,this._height=u;var s=t.latLngToLayerPoint(this._topLeft),o=t.latLngToLayerPoint(this._bottomRight);this._diagonal=Math.ceil(s.distanceTo(o)),i.style.width=p+"px",i.style.height=u+"px",L.DomUtil.setPosition(i,h.min);var P=p/f*Math.cos(d),T=u/c*Math.cos(m);a.style.transformOrigin="0px 0px 0px",a.style.transform="translate("+l.x+"px, "+l.y+"px) skew("+m+"rad, "+d+"rad) scale("+P+", "+T+") "}}},_initImage:function(){var t=this._url,a=this._rawImage,i=this.options;t&&((a=this._rawImage=L.DomUtil.create("img")).style.display="none",a.src=t,i.crossOrigin&&(a.crossOrigin="")),a.alt=i.alt,L.DomUtil.addClass(a,"leaflet-image-layer");var e=this._image=L.DomUtil.create("div","leaflet-image-layer leaflet-zoom-animated leaflet-image-transform");e.appendChild(a),e.onselectstart=L.Util.falseFn,e.onmousemove=L.Util.falseFn,a.onload=function(){this._reset(),a.style.display="block",this.fire("load")}.bind(this)},_parseLatLngs:function(t){this._latlngs=t,this._bottomLeft=L.latLng(t[0]),this._topLeft=L.latLng(t[1]),this._topRight=L.latLng(t[2]),this._bottomRight=L.latLng(t[3])},_getCenterOfLatLngs:function(t){return this._getCenterOf2LatLngs(t[1],t[3])},_getCenterOf2LatLngs:function(t,a){var i=this._map;if(i){var e=i.latLngToLayerPoint(t),s=i.latLngToLayerPoint(a);return i.layerPointToLatLng(L.point((e.x+s.x)/2,(e.y+s.y)/2))}return L.latLng((t.lat+a.lat)/2,(t.lng+a.lng)/2)},_getRadianFromLatLngs:function(t){var a=this._map;if(a){var i=a.latLngToLayerPoint(t[0]),e=a.latLngToLayerPoint(t[1]),s=a.latLngToLayerPoint(t[2]),n=a.latLngToLayerPoint(t[3]),r=e.x-i.x,o=e.y-i.y,h=s.x-n.x,l=s.y-n.y;return o<0?-Math.atan(r/o):Math.PI-Math.atan(h/l)}},_scaleLatLngs:function(t,a,i,e,s,n){var r=this._map;if(r){var o,h=r.latLngToLayerPoint(this._getCenterOfLatLngs(e)),l=e.slice(0),g=this._getRadianFromLatLngs(l);r.latLngToLayerPoint(e[0]),r.latLngToLayerPoint(e[1]),r.latLngToLayerPoint(e[2]),r.latLngToLayerPoint(e[3]);switch(i){case"bottomLeft":o=0;break;case"bottom":o=0,t=0;break;case"topLeft":o=1;break;case"left":o=1,a=0;break;case"topRight":o=2;break;case"top":o=2,t=0;break;case"bottomRight":o=3;break;case"right":o=3,a=0}var _=r.latLngToLayerPoint(l[o]),d=L.point(_.x+(t||0),_.y+(a||0));if(s)var m=(o+2)%4,f=r.latLngToLayerPoint(l[m]),c=f.distanceTo(d)/n,d=L.point(f.x+(_.x-f.x)*c,f.y+(_.y-f.y)*c);switch(l[o]=r.layerPointToLatLng(d),g&&0!==g&&(l=this._rotateLatLngs(-g,l,h)),o){case 0:l[1]=L.latLng(l[2].lat,l[0].lng),l[3]=L.latLng(l[0].lat,l[2].lng);break;case 1:l[0]=L.latLng(l[3].lat,l[1].lng),l[2]=L.latLng(l[1].lat,l[3].lng);break;case 2:l[1]=L.latLng(l[2].lat,l[0].lng),l[3]=L.latLng(l[0].lat,l[2].lng);break;case 3:l[0]=L.latLng(l[3].lat,l[1].lng),l[2]=L.latLng(l[1].lat,l[3].lng)}return g&&0!==g&&(l=this._rotateLatLngs(g,l,h)),l}},_moveLatLngs:function(t,a,i){var e=this._map;if(e=this._map){for(var s,n=[],r=0;r<4;r++)(s=e.latLngToLayerPoint(i[r])).x+=t,s.y+=a,n.push(e.layerPointToLatLng(s));return n}},_rotateLatLngs:function(t,a,i){var e=this._map;if(e){for(var s,i=i||e.latLngToLayerPoint(this._getCenterOfLatLngs(a)),n=Math.sin(t)||0,r=Math.cos(t)||0,o=[],h=0;h<4;h++)(s=e.latLngToLayerPoint(a[h])).x-=i.x,s.y-=i.y,o.push(e.layerPointToLatLng(L.point([i.x+s.x*r-s.y*n,i.y+s.x*n+s.y*r])));return o}},_createMarkers:function(){var t=this._map;if(t){var a=this._markerClass,i=(this._latlngs,this._bottomLeft),e=this._topLeft,s=this._topRight,n=this._bottomRight,r=this._scalable,o=this._rotatable,h=this._lineGuideOptions,l=this._keepRatio,g=this._handlers={},_=this._handlersGroup=this._handlersGroup||new L.LayerGroup,d=[i,e,s,n,i],m=L.polyline(d,h);if(g.guideLine=m,_.addLayer(m),o){var f,c=this._getCenterOf2LatLngs(e,s),y=t.latLngToLayerPoint(this._getCenterOf2LatLngs(i,n)),p=t.latLngToLayerPoint(this._getCenterOf2LatLngs(e,s)),u=y.distanceTo(p);f=0!=u?20/u+1:1;var v=t.layerPointToLatLng(L.point(y.x+(p.x-y.x)*f,y.y+(p.y-y.y)*f)),b=new a(v,{name:"rotation"});b.on("mousedown",this._onRotateStart,this);var P=L.polyline([c,v],h);g.rotation=b,g.rotationLine=P,_.addLayer(P),_.addLayer(b)}if(r){var T=new a(i,{name:"bottomLeft"}),k=new a(e,{name:"topLeft"}),x=new a(s,{name:"topRight"}),M=new a(n,{name:"bottomRight"});if(T.on("mousedown",this._onScaleStart,this),k.on("mousedown",this._onScaleStart,this),x.on("mousedown",this._onScaleStart,this),M.on("mousedown",this._onScaleStart,this),g.bottomLeft=T,g.topLeft=k,g.topRight=x,g.bottomRight=M,_.addLayer(T),_.addLayer(k),_.addLayer(x),_.addLayer(M),!l){var w=new a(this._getCenterOf2LatLngs(i,e),{name:"left"}),O=new a(this._getCenterOf2LatLngs(e,s),{name:"top"}),R=new a(this._getCenterOf2LatLngs(s,n),{name:"right"}),S=new a(this._getCenterOf2LatLngs(n,i),{name:"bottom"});w.on("mousedown",this._onScaleStart,this),O.on("mousedown",this._onScaleStart,this),R.on("mousedown",this._onScaleStart,this),S.on("mousedown",this._onScaleStart,this),g.left=w,g.top=O,g.right=R,g.bottom=S,_.addLayer(w),_.addLayer(O),_.addLayer(R),_.addLayer(S)}}_.addTo(t)}},_removeMarkers:function(){var t=this._map;if(t){var a=this._handlersGroup;a&&(t.removeLayer(a),a=this._handlersGroup=null)}},_resetMarkers:function(){this._removeMarkers(),this._createMarkers()},_hideMarkers:function(){}}),L.imageOverlay.transform=function(t,a,i){return new L.ImageOverlay.Transform(t,a,i)};